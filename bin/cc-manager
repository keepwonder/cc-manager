#!/usr/bin/env bash
# ==============================================================================
# cc-manager - Claude Code Provider Manager
# ==============================================================================
# This is a wrapper script that provides proper shell integration
# ==============================================================================

# Determine installation directory
if [[ -n "${CC_MANAGER_HOME}" ]]; then
    CC_MANAGER_ROOT="${CC_MANAGER_HOME}"
elif [[ -f "${HOME}/.local/lib/cc-manager/core.sh" ]]; then
    CC_MANAGER_ROOT="${HOME}/.local/lib/cc-manager"
elif [[ -f "/usr/local/lib/cc-manager/core.sh" ]]; then
    CC_MANAGER_ROOT="/usr/local/lib/cc-manager"
else
    # Development mode
    CC_MANAGER_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib" && pwd)"
fi

# Check for shell integration
SHELL_INTEGRATION="${CC_MANAGER_ROOT}/shell-integration.sh"

# If called directly (not from shell function), show helpful message
if [[ -f "$SHELL_INTEGRATION" ]] && [[ "$1" =~ ^(switch|sw|back|b)$ ]]; then
    cat >&2 << 'EOF'
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️  IMPORTANT: Shell Integration Required
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

For 'switch' and 'back' commands to work properly, you need to enable
shell integration. This allows cc-manager to set environment variables
in your current shell.

Quick Setup:
  1. Add this to your ~/.bashrc or ~/.zshrc:

EOF

    if [[ -f "/usr/local/lib/cc-manager/shell-integration.sh" ]]; then
        cat >&2 << 'EOF'
     source /usr/local/lib/cc-manager/shell-integration.sh
EOF
    elif [[ -f "$HOME/.local/lib/cc-manager/shell-integration.sh" ]]; then
        cat >&2 << EOF
     source \$HOME/.local/lib/cc-manager/shell-integration.sh
EOF
    else
        cat >&2 << EOF
     source $SHELL_INTEGRATION
EOF
    fi

    cat >&2 << 'EOF'

  2. Reload your shell:

     source ~/.bashrc  # or ~/.zshrc

  3. Then use cc-manager as normal:

     cc-manager switch deepseek

After setup, all cc-manager commands will work seamlessly!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Continuing with command (environment variables will NOT persist)...

EOF
fi

# Execute the actual binary
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CC_MANAGER_BIN="${SCRIPT_DIR}/cc-manager-bin"

if [[ ! -f "$CC_MANAGER_BIN" ]]; then
    echo "Error: cc-manager binary not found: $CC_MANAGER_BIN" >&2
    exit 1
fi

exec "$CC_MANAGER_BIN" "$@"
